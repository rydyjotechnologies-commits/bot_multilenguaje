<script>
let audioPermitido = false;
let ultimoTexto = "";

function activarAudio() {
    audioPermitido = true;
    alert("ðŸ”Š Audio activado. El bot ya puede hablar.");
}

async function enviar() {
    const mensaje = document.getElementById("mensaje").value;

    const res = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ mensaje })
    });

    const data = await res.json();
    ultimoTexto = data.respuesta;

    document.getElementById("respuesta").innerText = ultimoTexto;

    if (audioPermitido) {
        hablar(ultimoTexto);
    }
}

function hablar(texto) {
    const voz = new SpeechSynthesisUtterance(texto);
    voz.lang = detectarIdioma(texto);
    voz.rate = 1;
    voz.pitch = 1;
    speechSynthesis.speak(voz);
}

function detectarIdioma(texto) {
    if (texto.match(/[Â¿Â¡Ã±Ã¡Ã©Ã­Ã³Ãº]/i)) return "es-ES";
    if (texto.match(/[a-z]/i)) return "en-US";
    if (texto.match(/[Ã§Ã©Ã¨Ã ]/i)) return "fr-FR";
    if (texto.match(/[Ã£Ãµ]/i)) return "pt-BR";
    return "es-ES";
}
</script>
